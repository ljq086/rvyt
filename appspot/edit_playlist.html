<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>rvyt: Reddit Videos to YouTube Playlist</title>
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/css/bootstrap.css" rel="stylesheet">
    <style>
      body {
        padding-top: 60px; /* 60px to make the container go all the way to the bottom of the topbar */
      }
    </style>
    <link href="/css/bootstrap-responsive.css" rel="stylesheet">

    <!-- Le fav and touch icons -->
    <!--
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="apple-touch-icon" href="/img/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png">
    -->
  </head>

  <body>      

    <div class="navbar navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <a class="brand" href="/">rvyt</a>
          <div class="nav-collapse">
            <ul class="nav">
              <li class="active"><a href="/">Home</a></li>
              <li><a href="/html/about.html">About</a></li>
              <li><a href="/html/contact.html">Contact</a></li>
            </ul>
          </div><!--/.nav-collapse -->
        </div>
      </div>
    </div>

    <div class="container-fluid">
        <div class="hero-unit">
            <h1>Now Playing</h1>

            <h2 id="now_playing"><span id="score"></span></h2>

            <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js"></script>    
            <div id="ytapiplayer">
                You need Flash player 8+ and JavaScript enabled to view this video.
            </div>
            <script type="text/javascript">
                var params = { allowScriptAccess: "always", allowFullScreen: "true" };
                var atts = { id: "myytplayer" };
                swfobject.embedSWF("http://www.youtube.com/v/{{first}}?enablejsapi=1&playerapiid=ytplayer&version=3",
                                   "ytapiplayer", "640", "360", "8", null, null, params, atts);
            </script>

            <p>
            <a class="btn" href="javascript:onPrev()">&laquo; Previous</a>
            <a class="btn" href="javascript:onNext()">Next &raquo;</a>
            <a class="btn" id="view_comments" href="">View all comments</a>
            </p>
        </div>
        <div class="row-fluid">
            <div class="span8">
                <h2>Customize Playlist</h2>
                
                <p>Check the box next to the videos you want to play, and click on "Play".
                You can also sort the playlist by clicking on the &#9650; and &#9660; buttons
                next to the property you want to sort by.</p>

                <p><a class="btn" href="javascript:onSelectAll();">Select all</a>
                <a class="btn" href="javascript:onSelectNone();">Select none</a>
                <a class="btn btn-success" href="javascript:onCuePlaylist(true);">Play</a></p>

                <hr>

                <table class="table">
                    <thead>
                        <tr>
                            <th></th>
                            <th width="75px">
                                Rank<a href="javascript:onSortByRank(false)">&#9650;</a><a href="javascript:onSortByRank(true)">&#9660;</a>
                            </th>
                            <th width="75px">
                                Score<a href="javascript:onSortByScore(false)">&#9650;</a><a href="javascript:onSortByScore(true)">&#9660;</a>
                            </th>
                            <th>Title</th>
                            <th width="100px">
                                Category<a href="javascript:onSortByCategory(false)">&#9650;</a><a href="javascript:onSortByCategory(true)">&#9660;</a>
                            </th>
                            <th width="100px">
                                Duration<a href="javascript:onSortByDuration(false)">&#9650;</a><a href="javascript:onSortByDuration(true)">&#9660;</a>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="playlist">
                    </tbody>
                </table>
        </div>
    </div>

<script src="/js/make.js"></script>
<script>
var nowPlaying = document.getElementById("now_playing");
var score = document.getElementById("score");
var all_entries = JSON.parse('{{all_entries}}')
var viewComments = document.getElementById("view_comments");
var tblPlaylist = document.getElementById('playlist');

var ytplayer;
var playlist;
var playlist_ids;

var categories = JSON.parse('{{categories}}');

var checked_status = new Array();

function updateNowPlaying(video_id) {
    //
    // TODO: make all_entries a map, this is too inefficient.
    //
    for (var i = 0; i < all_entries.length; ++i) {
        if (all_entries[i].vid == video_id) {
            entryDetails = all_entries[i];
            console.debug('now playing: ' + entryDetails[i]);
            nowPlaying.innerHTML = '#{0} [ {2} ] {1}'.format(
                (entryDetails.rank+1), entryDetails.title, entryDetails.score);
            viewComments.href = "http://www.reddit.com" + entryDetails.permalink;
            break;
        }
    }
}

function onPlayerStateChange(newState) {
    console.debug('onPlayerStateChange(): ' + newState);
    pattern = /v=([\w-]{11})/;
    result = ytplayer.getVideoUrl().match(pattern);
    console.debug(result[1]);
    updateNowPlaying(result[1]);
}

function onYouTubePlayerReady(playerId) {
    ytplayer = document.getElementById("myytplayer");
    ytplayer.addEventListener("onStateChange", "onPlayerStateChange");
    onCuePlaylist(false);
}

function onSortByScore(reverse) {
    updateCheckedStatus();
    all_entries.sort(
        function (a,b) { 
            if (reverse)
                return Number(b.score) - Number(a.score) 
            else
                return Number(a.score) - Number(b.score) 
        }
    );
    updatePlaylist();
    rebuildTable();
}

function onSortByRank(reverse) {
    updateCheckedStatus();
    all_entries.sort(
        function (a,b) { 
            if (reverse)
                return Number(b.rank) - Number(a.rank) 
            else
                return Number(a.rank) - Number(b.rank) 
        }
    );
    updatePlaylist();
    rebuildTable();
}

function onSortByCategory(reverse) {
    updateCheckedStatus();
    all_entries.sort(
        function (a,b) { 
            if (reverse)
                return b.category.localeCompare(a.category);
            else
                return a.category.localeCompare(b.category);
        }
    );
    console.debug(all_entries);
    updatePlaylist();
    rebuildTable();
}

function onSortByDuration(reverse) {
    updateCheckedStatus();
    all_entries.sort(
        function (a,b) { 
            if (reverse)
                return b.duration - a.duration;
            else
                return a.duration - b.duration;
        }
    );
    console.debug(all_entries);
    updatePlaylist();
    rebuildTable();
}

function updateCheckedStatus() {
    for (i=0; i < all_entries.length; ++i) {
        var checkbox = document.getElementById('check_' + i);
        if (!checkbox)
            continue;
        checked_status[all_entries[i].rank] = checkbox.checked;
    }
}

function rebuildTable() {
    var rows = new Array();
    var cells = new Array();

    while (tblPlaylist.rows.length)
        tblPlaylist.deleteRow(0);

    for (i=0; i < all_entries.length; ++i) {
        var newRow = document.createElement('tr');
        tblPlaylist.appendChild(newRow)

        cells[0] = undefined;
        cells[1] = 1 + all_entries[i].rank;
        cells[2] = '<strong>' + all_entries[i].score + '</strong>';
        cells[3] = all_entries[i].title;
        cells[4] = all_entries[i].category;
        cells[5] = '';

        if (all_entries[i].duration) {
            var minutes = Math.floor(all_entries[i].duration/60);
            var seconds = all_entries[i].duration-60*minutes;
            if (seconds < 10)
                seconds = "0" + String(seconds);
            else
                seconds = String(seconds)
            cells[5] = String(minutes) + ':' + seconds;
        }

        for (j = 0; j < cells.length; ++j) {
            var newCell = document.createElement('td');
            switch (j) {
                case 0:
                    if (all_entries[i].vid) {                     
                        var check = document.createElement('input');
                        check.type = 'checkbox';
                        check.name = 'select';
                        check.value = i;
                        check.id = 'check_' + i;
                        check.checked = checked_status[all_entries[i].rank];
                        newCell.appendChild(check);
                    }
                    break;
                case 3:
                    if (all_entries[i].vid) {
                        var hyperlink = document.createElement('a');
                        hyperlink.href = 'javascript:onClickVideo(' + all_entries[i].rank + ')';
                        hyperlink.innerHTML = cells[j];
                        newCell.appendChild(hyperlink);
                    } else {
                        newCell.innerHTML = cells[j];
                    }
                    break;
                default:
                    newCell.innerHTML = cells[j];
            }
            if (!categories.length || 
                    categories.indexOf(all_entries[i].category) != -1)
                newRow.appendChild(newCell);
        }
    }
}

function onSelectNone() {
    for (i=0; i < all_entries.length; ++i) {
        var check = document.getElementById('check_' + i);
        if (check)
            check.checked = false;
    }
}

function onSelectAll() {
    for (i=0; i < all_entries.length; ++i) {
        var check = document.getElementById('check_' + i);
        if (check)
            check.checked = true;
    }
}

function updatePlaylist() {
    playlist = new Array();
    playlist_ids = new Array();
    for (i=0; i < all_entries.length; ++i) {
        var check = document.getElementById('check_' + i);
        if (check && check.checked) {
            playlist_ids.push(all_entries[i].vid);
            playlist.push(all_entries[i]);
        }
    }
}

function onCuePlaylist(play) {
    updatePlaylist();
    if (!playlist) {
        alert('Nothing to play');
    } else {
        if (play)
            ytplayer.loadPlaylist(playlist_ids.join(','), 0);
        else
            ytplayer.cuePlaylist(playlist_ids.join(','), 0);
        updateNowPlaying(0);
    }
}

function onClickVideo(rank) {
    window.scrollTo(0,0);
    updatePlaylist();
    for (i = 0; i < playlist.length; ++i) {
        if (playlist[i].rank == rank) {
            ytplayer.loadPlaylist(playlist_ids, i);
            return;
        }
    }
    ytplayer.loadPlaylist([ all_entries[rank].vid ], 0);
}

function onPrev() {
    idx = ytplayer.getPlaylistIndex();
    if (idx)
        --idx;
    ytplayer.loadPlaylist(playlist_ids, idx);
}

function onNext() {
    idx = ytplayer.getPlaylistIndex();
    if (++idx < playlist_ids.length) {
        ytplayer.loadPlaylist(playlist_ids, idx);
    }
}

for (i=0; i < all_entries.length; ++i) {
    checked_status[all_entries[i].rank] = true;
}
rebuildTable();
</script>
<script type="text/javascript">
</script>

    <!-- Le javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!--
    <script src="/js/jquery.js"></script>
    <script src="/js/bootstrap-transition.js"></script>
    <script src="/js/bootstrap-alert.js"></script>
    <script src="/js/bootstrap-modal.js"></script>
    <script src="/js/bootstrap-dropdown.js"></script>
    <script src="/js/bootstrap-scrollspy.js"></script>
    <script src="/js/bootstrap-tab.js"></script>
    <script src="/js/bootstrap-tooltip.js"></script>
    <script src="/js/bootstrap-popover.js"></script>
    <script src="/js/bootstrap-button.js"></script>
    <script src="/js/bootstrap-collapse.js"></script>
    <script src="/js/bootstrap-carousel.js"></script>
    <script src="/js/bootstrap-typeahead.js"></script>
    -->

  </body>
</html>
