<html>
    <head>
        <link type="text/css" rel="stylesheet" href="/stylesheets/main.css" />
    </head>
    <body>
        <h1>Result</h1>

        <p>Your playlist is <a href="{{plist_url}}">here</a>.  
        It is <span id="percent_complete">0</span>% complete.</p>

        <h2>Problems, comments or suggestions?</h2>

        <p>Please let me know about them: misha [dot] penkov [at] gmail [dot] com</p>

        <p>[ <a href="http://www.reddit.com/r/videos">reddit</a> | 
        <a href="http://www.youtube.com">youtube</a> |
        <a href="https://github.com/mpenkov/rvyt">rvyt@github</a> ]</p>

        <script src='/_ah/channel/jsapi'></script>
        <!-- 
        The JavaScript reference says that all JS needs to go in the body:
        http://code.google.com/appengine/docs/python/channel/javascript.html
        This is required for the Django string substitution stuff to work.

        It's a real pain in the ass.
        http://vim.wikia.com/wiki/How_to_stop_auto_indenting

        :setlocal noautoindent
        :setlocal nocindent
        :setlocal nosmartindent
        :setlocal indentexpr=
        -->
        <script type="text/javascript" src="js/make.js"></script>
        <script type="text/javascript">
onOpen = function() {
    console.debug('Opened socket')
    var request = new XMLHttpRequest();
    request.open('POST', '/opened');
    var params = { 
            'channel_id' : '{{channel_id}}',
            'plist_uri' : '{{plist_uri}}',
            'limit' : '{{limit}}' };
    //
    // From O'Reilly textbook page 503
    // Replace ALL encoded spaces using regular expressions.
    //
    var pairs = [ ];
    for (var name in params) {
        var value = params[name].toString();
        name = encodeURIComponent(name).replace(/%20/g, '+');
        value = encodeURIComponent(value).replace(/%20/g, '+');
        pairs.push(name + '=' + value);
    }
    request.setRequestHeader(
            'Content-Type', 
            'application/x-www-form-urlencoded')

    data = pairs.join('&')
    request.send(data);
};

var completed = 0;
var percentComplete = document.getElementById('percent_complete');
onMessage = function(message) {
    if (message['data'] == 'done') {
        completed += 1;
    }
    percent_complete.innerHTML = (100*completed/{{limit}}).toFixed(0);
};

onError = function(message) {
    console.debug("Error:" + messageToStr(message));
};

onClose = function() {
    console.debug("Closed socket");
};

var channel = new goog.appengine.Channel('{{ token }}');
var handler = { 'onopen' : onOpen, 'onmessage' : onMessage,
                'onerror' : onError, 'onclose' : onClose }
var socket = channel.open(handler);
        </script>
    </body>
</html>
